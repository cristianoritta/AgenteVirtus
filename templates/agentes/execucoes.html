{% extends 'layout/base.html' %}

{% block main %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            {% if equipe %}
                Execuções da Equipe: {{ equipe.nome }}
            {% else %}
                Todas as Execuções
            {% endif %}
        </h1>
        <div>
            {% if equipe %}
                <a href="/agentesinteligentes/equipes" class="btn btn-sm btn-secondary shadow-sm">
                    <i class="fas fa-arrow-left"></i> Voltar para Equipes
                </a>
            {% else %}
                <a href="/agentesinteligentes/equipes" class="btn btn-sm btn-primary shadow-sm">
                    <i class="fas fa-robot"></i> Ver Equipes
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-filter"></i> Filtros
            </h6>
        </div>
        <div class="card-body">
            <form method="GET" class="mb-0">
                <div class="row">
                    {% if not equipe %}
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Equipe</label>
                            <select name="equipe" class="form-select">
                                <option value="">Todas</option>
                                {% for eq in equipes %}
                                <option value="{{ eq.id }}" {% if filtros.equipe == eq.id %}selected{% endif %}>
                                    {{ eq.nome }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% endif %}
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Sprint</label>
                            <input type="number" name="sprint" class="form-control" value="{{ filtros.sprint }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Contexto contém</label>
                            <input type="text" name="contexto" class="form-control" value="{{ filtros.contexto }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Resposta contém</label>
                            <input type="text" name="resposta" class="form-control" value="{{ filtros.resposta }}">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 text-right">
                        <a href="?" class="btn btn-secondary">Limpar</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Content Row -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> 
                {% if equipe %}
                    Execuções da Equipe
                {% else %}
                    Todas as Execuções
                {% endif %}
            </h6>
        </div>
        <div class="card-body">
            {% if execucoes %}
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Equipe</th>
                                <th>Sprint</th>
                                <th>Contexto</th>
                                <th>Resposta</th>
                                <th>Data</th>
                                <th width="1%">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for execucao in execucoes.items %}
                            <tr>
                                <td>{{ execucao.id }}</td>
                                <td>
                                    {% if equipe %}
                                        {{ equipe.nome }}
                                    {% else %}
                                        {{ execucao.equipe.nome }}
                                    {% endif %}
                                </td>
                                <td>{{ execucao.sprint }}</td>
                                <td>
                                    {% if execucao.contexto %}
                                        {{ execucao.contexto[:100] }}{% if execucao.contexto|length > 100 %}...{% endif %}
                                    {% else %}
                                        <span class="text-muted">Sem contexto</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if execucao.resposta %}
                                        {% if "Execução completa" in execucao.resposta %}
                                            <span class="badge badge-success">Resumo Final</span>
                                        {% else %}
                                            {{ execucao.resposta[:100] }}{% if execucao.resposta|length > 100 %}...{% endif %}
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Sem resposta</span>
                                    {% endif %}
                                </td>
                                <td>{{ execucao.criado_em.strftime('%d/%m/%Y %H:%M') }}</td>
                                <td nowrap>

                                    {% if "Execução completa" in execucao.resposta %}
                                    <a href="/agentesinteligentes/download_arquivo/{{ execucao.equipe_id }}/{{ execucao.id }}/txt" class="btn btn-primary btn-sm">   
                                        <i class="fas fa-download"></i> Download
                                    </a>
                                    {% endif %}
                                    
                                    <a href="/agentesinteligentes/execucao/{{ execucao.id }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye"></i> Ver
                                    </a>
                                    
                                    <button type="button" class="btn btn-danger btn-sm btn-excluir"
                                        data-execucao-id="{{ execucao.id }}" data-execucao-contexto="{{ execucao.contexto }}">
                                        <i class="fas fa-trash"></i> Excluir
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                <div class="d-flex justify-content-between align-items-center mt-4">
                    <div>
                        Mostrando {{ execucoes.items|length }} de {{ execucoes.total }} execuções
                    </div>
                    <nav aria-label="Navegação de página">
                        <ul class="pagination mb-0">
                            <!-- Primeira página -->
                            <li class="page-item {% if not execucoes.has_prev %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('listar_execucoes', page=1, equipe=filtros.equipe, sprint=filtros.sprint, contexto=filtros.contexto, resposta=filtros.resposta) }}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            
                            <!-- Página anterior -->
                            <li class="page-item {% if not execucoes.has_prev %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('listar_execucoes', page=execucoes.prev_num, equipe=filtros.equipe, sprint=filtros.sprint, contexto=filtros.contexto, resposta=filtros.resposta) }}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>

                            <!-- Páginas -->
                            {% for page_num in execucoes.iter_pages(left_edge=2, left_current=2, right_current=2, right_edge=2) %}
                                {% if page_num %}
                                    <li class="page-item {% if page_num == execucoes.page %}active{% endif %}">
                                        <a class="page-link" href="{{ url_for('listar_execucoes', page=page_num, equipe=filtros.equipe, sprint=filtros.sprint, contexto=filtros.contexto, resposta=filtros.resposta) }}">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Próxima página -->
                            <li class="page-item {% if not execucoes.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('listar_execucoes', page=execucoes.next_num, equipe=filtros.equipe, sprint=filtros.sprint, contexto=filtros.contexto, resposta=filtros.resposta) }}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>

                            <!-- Última página -->
                            <li class="page-item {% if not execucoes.has_next %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('listar_execucoes', page=execucoes.pages, equipe=filtros.equipe, sprint=filtros.sprint, contexto=filtros.contexto, resposta=filtros.resposta) }}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <p>Nenhuma execução encontrada.</p>
                </div>
            {% endif %}
        </div>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Adicionar event listeners para todos os botões de excluir
        const botoesExcluir = document.querySelectorAll('.btn-excluir');

        botoesExcluir.forEach(function (botao) {
            botao.addEventListener('click', function () {
                const execucaoId = this.getAttribute('data-execucao-id');
                const contexto = this.getAttribute('data-execucao-contexto');

                Swal.fire({
                    title: 'Confirmar Exclusão',
                    text: 'Tem certeza que deseja excluir esta execução?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sim, excluir!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Mostrar loading
                        Swal.fire({
                            title: 'Excluindo...',
                            text: 'Aguarde enquanto excluímos a execução.',
                            allowOutsideClick: false,
                            didOpen: () => {
                                Swal.showLoading();
                            }
                        });
                        
                        // Criar um formulário temporário para fazer a requisição POST
                        const form = document.createElement('form');
                        form.method = 'POST';
                        form.action = '/agentesinteligentes/execucao/' + execucaoId + '/excluir';
                        document.body.appendChild(form);
                        form.submit();
                    }
                });
            });
        });
    });
</script>
{% endblock %} 