{% extends 'layout/base.html' %}

{% block main %}
<div class="container-fluid">

    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Resultado do Processamento</h1>
        <div>
            <a href="/agentesinteligentes/equipes" class="btn btn-sm btn-secondary shadow-sm">
                <i class="fas fa-arrow-left"></i> Voltar para Equipes
            </a>
        </div>
    </div>

    <!-- Resultado Final -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-success">
                <i class="fas fa-check-circle"></i> Resultado Final
            </h6>
        </div>
        <div class="card-body">
            <div class="bg-light p-3 rounded">
                <div class="d-flex justify-content-end mb-2">
                    <button onclick="copiarTexto('resultado-final')" class="btn btn-sm btn-primary me-2">
                        <i class="fas fa-copy"></i> Copiar
                    </button>
                    <button onclick="downloadTexto('{{ resultado }}')" class="btn btn-sm btn-success">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
                <pre id="resultado-final" class="mb-0" style="white-space: pre-wrap; font-family: 'Courier New', monospace;">{{ resultado }}</pre>
            </div>
        </div>
    </div>

    <!-- Detalhes do Processamento -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-list"></i> Detalhes do Processamento
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                {% for resposta in respostas %}
                <div class="col-12 mb-4">
                    <div class="card border-left-primary shadow h-100">
                        <div class="card-header py-3">
                            <div class="d-flex align-items-center">
                                {% if resposta.node.type == 'agent' %}
                                    <i class="fas fa-robot text-primary me-2"></i>
                                    <span class="font-weight-bold text-primary">Agente: {{ resposta.node.config.role if resposta.node.config.role else 'Agente' }}</span>
                                {% elif resposta.node.type == 'task' %}
                                    <i class="fas fa-cogs text-warning me-2"></i>
                                    <span class="font-weight-bold text-warning">Tarefa: {{ resposta.node.config.description if resposta.node.config.description else 'Tarefa' }}</span>
                                {% elif resposta.node.type == 'guardrail' %}
                                    <i class="fas fa-shield-alt text-danger me-2"></i>
                                    <span class="font-weight-bold text-danger">Guardrail: {{ resposta.node.config.name if resposta.node.config.name else 'Guardrail' }}</span>
                                {% elif resposta.node.type == 'formatoSaida' %}
                                    <i class="fas fa-file-alt text-success me-2"></i>
                                    <span class="font-weight-bold text-success">Formato de Saída: {{ resposta.node.config.type if resposta.node.config.type else 'Formato' }}</span>
                                {% else %}
                                    <i class="fas fa-list-alt text-info me-2"></i>
                                    <span class="font-weight-bold text-info">{{ resposta.node.type|title }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="bg-light p-3 rounded mb-3">
                                <pre style="white-space: pre-wrap; font-family: 'Courier New', monospace; margin: 0;">{{ resposta.resposta }}</pre>
                            </div>
                            
                            {% if resposta.node.type == 'formatoSaida' and resposta.arquivo_download %}
                            <div class="text-center">
                                <button onclick="downloadArquivo('{{ resposta.node.id }}')" class="btn btn-success">
                                    <i class="fas fa-download"></i> Download do Arquivo
                                </button>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

</div>

<script>
    function downloadArquivo(nodeId) {
        // Obter o formato do nó a partir dos dados da página
        const nodeData = getNodeData(nodeId);
        if (nodeData && nodeData.formato) {
            const url = `/agentesinteligentes/download_arquivo/{{ equipe.id }}/${nodeId}/${nodeData.formato}`;
            window.open(url, '_blank');
        } else {
            Swal.fire({
                title: 'Erro!',
                text: 'Formato não encontrado para este nó!',
                icon: 'error'
            });
        }
    }
    
    function getNodeData(nodeId) {
        // Buscar os dados do nó na página
        const nodeElements = document.querySelectorAll('.card-body');
        for (let element of nodeElements) {
            const header = element.parentElement.querySelector('.card-header');
            if (header && header.textContent.includes('Formato de Saída')) {
                // Extrair o formato do texto do header
                const formatoMatch = header.textContent.match(/Formato de Saída: (.+)/);
                if (formatoMatch) {
                    return { formato: formatoMatch[1].toLowerCase() };
                }
            }
        }
        return null;
    }

    function copiarTexto(elementId) {
        const elemento = document.getElementById(elementId);
        const texto = elemento.textContent;
        
        navigator.clipboard.writeText(texto).then(() => {
            // Mostrar feedback visual
            Swal.fire({
                title: 'Copiado!',
                text: 'Texto copiado para a área de transferência',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }).catch(err => {
            console.error('Erro ao copiar texto:', err);
            Swal.fire({
                title: 'Erro!',
                text: 'Não foi possível copiar o texto',
                icon: 'error'
            });
        });
    }

    function downloadTexto(texto) {
        // Criar um blob com o texto
        const blob = new Blob([texto], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        
        // Criar um link temporário e clicar nele
        const a = document.createElement('a');
        a.href = url;
        a.download = `resultado_${new Date().toISOString().slice(0,19).replace(/[:-]/g, '')}.txt`;
        document.body.appendChild(a);
        a.click();
        
        // Limpar
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }
</script>
{% endblock %}