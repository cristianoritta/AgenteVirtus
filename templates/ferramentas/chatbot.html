{% extends "layout/base.html" %}

{% block main %}
<div class="container-fluid p-3">
    <div class="row g-3">
        <!-- Barra lateral com conversas -->
        <div class="col-md-3">
            <div class="card h-90">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="fas fa-history"></i> Conversas
                        </h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="criarNovaConversa()">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="lista-conversas-sidebar" class="list-group list-group-flush"
                        style="max-height: calc(100vh - 200px); overflow-y: auto;">
                        <!-- Conversas serão carregadas aqui -->
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-spinner fa-spin"></i> Carregando...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Container principal do chat -->
        <div class="col-md-9">
            <div class="card h-90">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-comments"></i> Chatbot com o Agente Virtus
                        </h5>
                        <div class="conversa-info" id="conversa-info" style="display: none;">
                            <small class="text-muted">
                                <i class="fas fa-link"></i>
                                <span id="conversa-titulo">Nova conversa</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary ml-2"
                                    onclick="editarTituloConversa()">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-inner chat-container">
                    <!-- Efeito de ondas -->
                    <div class="waves">
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                    </div>

                    <!-- Área de mensagens com scroll -->
                    <div id="chat-messages" class="chat-messages"
                        style="height: calc(100vh - 320px); overflow-y: auto;">

                        <!-- Mensagem de boas-vindas do assistente -->
                        <div class="message message-assistant">
                            <i class="icon fas fa-robot"></i>
                            Olá, eu sou o chatbot <strong>AgenteVirtus</strong>. Estou aqui para te ajudar
                            a entender seus dados. Todas as minhas respostas são baseadas nos dados que você me
                            forneceu.
                            Mas lembre-se, eu sou um chatbot e não tenho consciência própria, então minhas respostas
                            podem
                            não ser perfeitas. Sempre revise as respostas antes de tomar decisões importantes.
                            <span class="message-time">Agora</span>
                        </div>

                        <!-- Indicador de digitação -->
                        <div id="typing-indicator" class="typing-indicator">
                            <em class="icon ni ni-user-fill me-2"></em> Assistente está digitando
                            <span class="ms-2"></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>

                    <!-- Barra de mensagem fixa na parte inferior -->
                    <div class="chat-input-area">
                        <form id="chat-form" method="POST" action="{{ url_for('chatbot') }}">
                            <input type="hidden" id="ultima-pergunta" name="ultima_pergunta" value="">
                            <input type="hidden" id="conversa_id" name="conversa_id"
                                value="{% if conversa_id %}{{ conversa_id }}{% endif %}">
                            <input type="hidden" id="hash_conversa" name="hash_conversa" value="">
                            <div class="chat-input-container">
                                <textarea type="text" class="form-control" id="mensagem-input" name="mensagem"
                                    placeholder="Digite sua mensagem...">{{ mensagem }}</textarea>
                                <button type="submit" class="btn-send ms-2">
                                    <em class="icon fas fa-paper-plane"></em>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para criar nova conversa -->
<div class="modal fade" id="modalNovaConversa" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Conversa</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formNovaConversa">
                    <div class="form-group">
                        <label for="titulo">Título da Conversa</label>
                        <input type="text" class="form-control" id="titulo" name="titulo"
                            placeholder="Digite um título para a conversa">
                    </div>
                    <div class="form-group">
                        <label for="tipo_conversa">Tipo de Conversa</label>
                        <select class="form-control" id="tipo_conversa" name="tipo_conversa">
                            <option value="chatbot">Chatbot</option>
                            <option value="transcricao">Transcrição</option>
                            <option value="assistente">Assistente</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarNovaConversa()">Criar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar título da conversa -->
<div class="modal fade" id="modalEditarTitulo" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Título da Conversa</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="formEditarTitulo">
                    <div class="form-group">
                        <label for="novo_titulo">Título da Conversa</label>
                        <input type="text" class="form-control" id="novo_titulo" name="titulo" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="salvarNovoTitulo()">Salvar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="{{ url_for('static', filename='css/chatbot.css') }}" rel="stylesheet">
<script>
    let conversaAtual = null;

    $(document).ready(function () {
        // Esconder o indicador de digitação
        $('#typing-indicator').removeClass('active');

        // Rolar para o final das mensagens
        const chatMessages = $('#chat-messages');
        if (chatMessages.length) {
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
        }

        // Carregar conversas na barra lateral
        carregarConversasSidebar();

        // Se há conversa_id na URL, carregar a conversa
        {% if conversa_id %}
        carregarConversa({{ conversa_id }});
    {% endif %}

    // Configuração do toggle para exibir/ocultar detalhes
    $('body').on('click', '.toggle-details', function () {
        const detalhes = $('.detalhes-analise');
        const icone = $(this).find('i');
        const texto = $(this).find('span');

        if (detalhes.is(':visible')) {
            // Ocultar detalhes
            detalhes.slideUp(200);
            icone.removeClass('fa-chevron-up').addClass('fa-chevron-down');
            texto.text('Ver detalhes da análise');
        } else {
            // Mostrar detalhes
            detalhes.slideDown(200);
            icone.removeClass('fa-chevron-down').addClass('fa-chevron-up');
            texto.text('Ocultar detalhes da análise');
        }

        // Rolar para o final após a animação
        setTimeout(function () {
            chatMessages.scrollTop(chatMessages[0].scrollHeight);
        }, 250);
    });

    // Capturar e armazenar a pergunta do usuário quando o formulário for enviado
    $('#chat-form').on('submit', function (e) {
        e.preventDefault();

        const pergunta = $('#mensagem-input').val();
        if (!pergunta.trim()) return;

        // Armazenar a pergunta no campo oculto
        $('#ultima-pergunta').val(pergunta);

        // Adicionar a mensagem do usuário ao chat
        appendUserMessage(pergunta);

        // Mostrar indicador de digitação
        $('#typing-indicator').addClass('active');

        // Limpar o campo de input
        $('#mensagem-input').val('');

        // Preparar dados para envio
        const formData = new FormData();
        formData.append('mensagem', pergunta);

        // Adicionar informações da conversa se existirem
        if (conversaAtual) {
            formData.append('conversa_id', conversaAtual.id);
            formData.append('hash_conversa', conversaAtual.hash_conversa);
        }

        // Enviar a requisição AJAX
        $.ajax({
            url: "{{ url_for('chatbot') }}",
            type: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                // Remover indicador de digitação
                $('#typing-indicator').removeClass('active');

                if (response.status === 'success') {
                    // Atualizar informações da conversa se for a primeira mensagem
                    if (!conversaAtual && response.conversa_id) {
                        conversaAtual = {
                            id: response.conversa_id,
                            hash_conversa: response.hash_conversa,
                            titulo: 'Nova conversa'
                        };
                        atualizarInfoConversa();
                        // Recarregar conversas na sidebar
                        carregarConversasSidebar();
                    }

                    // Adicionar a resposta do assistente
                    appendAssistantMessage(response.resposta);
                } else {
                    // Mostrar mensagem de erro
                    appendAssistantMessage("Ocorreu um erro ao processar sua mensagem. Por favor, tente novamente.");
                }

                // Rolar para o final
                const chatMessages = document.getElementById('chat-messages');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            },
            error: function (xhr, status, error) {
                // Remover indicador de digitação
                $('#typing-indicator').removeClass('active');

                // Mostrar mensagem de erro
                appendAssistantMessage("Ocorreu um erro ao processar sua mensagem. Por favor, tente novamente.");
                console.error("Erro:", error);
            }
        });
    });

    // Função para carregar conversas na barra lateral
    function carregarConversasSidebar() {
        fetch('/api/conversas/sidebar')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    exibirConversasSidebar(data.conversas);
                } else {
                    console.error('Erro ao carregar conversas:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
            });
    }

    // Função para exibir conversas na barra lateral
    function exibirConversasSidebar(conversas) {
        const container = document.getElementById('lista-conversas-sidebar');
        container.innerHTML = '';

        if (conversas.length === 0) {
            container.innerHTML = '<div class="list-group-item text-muted text-center">Nenhuma conversa encontrada</div>';
            return;
        }

        conversas.forEach(conversa => {
            const item = document.createElement('div');
            item.className = 'list-group-item list-group-item-action conversa-sidebar-item';
            item.onclick = (e) => {
                // Evita abrir a conversa ao clicar na lixeira
                if (e.target.closest('.btn-delete-conversa')) return;
                carregarConversa(conversa.id);
            };

            // Destacar conversa ativa
            if (conversaAtual && conversaAtual.id === conversa.id) {
                item.classList.add('active');
            }

            item.innerHTML = `
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <h6 class="mb-1 text-truncate" style="max-width: 150px;">${conversa.titulo}</h6>
                    <div class="d-flex align-items-center">
                        <small class="text-muted mr-2">${conversa.tipo_conversa}</small>
                        <button class="btn btn-sm btn-link text-danger btn-delete-conversa" title="Excluir conversa" style="display:none;padding:0 4px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <p class="mb-1 text-muted small">${conversa.total_mensagens} mensagens</p>
                <small class="text-muted">${conversa.atualizada_em}</small>
            `;

            // Evento para deletar conversa
            item.querySelector('.btn-delete-conversa').onclick = function (ev) {
                ev.stopPropagation();
                if (confirm('Tem certeza que deseja excluir esta conversa?')) {
                    deletarConversa(conversa.id);
                }
            };

            // Mostrar botão de deletar ao passar mouse
            item.onmouseenter = function () {
                const btn = item.querySelector('.btn-delete-conversa');
                if (btn) btn.style.display = 'inline-block';
            };
            item.onmouseleave = function () {
                const btn = item.querySelector('.btn-delete-conversa');
                if (btn) btn.style.display = 'none';
            };

            container.appendChild(item);
        });
    }

    // Função para carregar uma conversa específica
    function carregarConversa(conversaId) {
        fetch(`/api/conversa?conversa_id=${conversaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    conversaAtual = data.conversa;
                    atualizarInfoConversa();

                    // Limpar chat atual
                    $('#chat-messages').html(`
                        <!-- Mensagem de boas-vindas do assistente -->
                        <div class="message message-assistant">
                            <i class="icon fas fa-robot"></i>
                            Olá, eu sou o chatbot <strong>AgenteVirtus</strong>. Estou aqui para te ajudar
                            a entender seus dados. Todas as minhas respostas são baseadas nos dados que você me
                            forneceu.
                            Mas lembre-se, eu sou um chatbot e não tenho consciência própria, então minhas respostas
                            podem
                            não ser perfeitas. Sempre revise as respostas antes de tomar decisões importantes.
                            <span class="message-time">Agora</span>
                        </div>

                        <!-- Indicador de digitação -->
                        <div id="typing-indicator" class="typing-indicator">
                            <em class="icon ni ni-user-fill me-2"></em> Assistente está digitando
                            <span class="ms-2"></span>
                            <span></span>
                            <span></span>
                        </div>
                    `);

                    // Carregar mensagens da conversa
                    data.mensagens.forEach(msg => {
                        if (msg.role === 'user') {
                            appendUserMessage(msg.conteudo);
                        } else if (msg.role === 'assistant') {
                            appendAssistantMessage(msg.conteudo);
                        }
                    });

                    // Atualizar sidebar
                    carregarConversasSidebar();

                    // Rolar para o final
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    console.error('Erro ao carregar conversa:', data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
            });
    }

    // Função para atualizar informações da conversa na interface
    function atualizarInfoConversa() {
        if (conversaAtual) {
            document.getElementById('conversa-titulo').textContent = conversaAtual.titulo;
            document.getElementById('conversa-info').style.display = 'block';
        }
    }

    // Função para criar nova conversa
    function criarNovaConversa() {
        document.getElementById('formNovaConversa').reset();
        $('#modalNovaConversa').modal('show');
    }

    // Função para salvar nova conversa
    function salvarNovaConversa() {
        const formData = new FormData(document.getElementById('formNovaConversa'));

        fetch('/api/conversa/criar', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    $('#modalNovaConversa').modal('hide');
                    // Carregar a nova conversa
                    carregarConversa(data.conversa.id);
                } else {
                    alert('Erro ao criar conversa: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Erro ao criar conversa');
            });
    }





    // Função para adicionar mensagem do usuário
    function appendUserMessage(message) {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const html = `
                <div class="message message-user">
                    <div class="message-content">
                        <div class="message-text"><i class="icon fas fa-user"></i> ${message}</div>
                    </div>
                    <span class="message-time text-black">${time}</span>
                </div>
            `;
        $('#chat-messages').append(html);

        // Rolar para o final
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Função para adicionar mensagem do assistente
    function appendAssistantMessage(message) {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        let respostaDireta = message;
        let detalhesResposta = null;

        // Se vier objeto (resposta estruturada)
        if (typeof message === 'object' && message !== null) {
            if (message.resposta_direta && message.detalhes && message.detalhes.trim() !== "") {
                respostaDireta = message.resposta_direta;
                detalhesResposta = message.detalhes;
            } else if (message.resposta_direta) {
                respostaDireta = message.resposta_direta;
            }
        }

        // Se vier string JSON (fallback antigo)
        if (typeof message === 'string') {
            try {
                const parsedMessage = JSON.parse(message);
                if (parsedMessage.resposta_direta && parsedMessage.detalhes && parsedMessage.detalhes.trim() !== "") {
                    respostaDireta = parsedMessage.resposta_direta;
                    detalhesResposta = parsedMessage.detalhes;
                } else if (parsedMessage.resposta_direta) {
                    respostaDireta = parsedMessage.resposta_direta;
                }
            } catch (e) {
                respostaDireta = message;
            }
        }

        // Ajusta a quebra de linha
        respostaDireta = respostaDireta.replace('\n', '<br>');

        const html = `
                <div class="message message-assistant">
                    <i class="icon fas fa-robot"></i>
                    <div class="message-content">
                        <div class="resposta-direta" style="white-space: pre-line;">${respostaDireta}</div>
                    </div>
                    <div class="message-time">${time}</div>
                    <div class="message-copy">
                        <a href="#" class="text-dark text-black" data-text="${respostaDireta.replace(/"/g, '&quot;')}" onclick="copyToClipboard(this)">
                            <i class="fas fa-copy"></i>
                        </a>
                    </div>
                </div>
            `;
        $('#chat-messages').append(html);
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Função para deletar conversa
    function deletarConversa(conversaId) {
        const formData = new FormData();
        formData.append('conversa_id', conversaId);
        fetch('/api/conversa/deletar', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Se deletou a conversa atual, limpa o chat
                    if (conversaAtual && conversaAtual.id == conversaId) {
                        conversaAtual = null;
                        $('#chat-messages').html(`
                        <div class="message message-assistant">
                            <i class="icon fas fa-robot"></i>
                            Olá, eu sou o chatbot <strong>AgenteVirtus</strong>. Estou aqui para te ajudar
                            a entender seus dados. Todas as minhas respostas são baseadas nos dados que você me
                            forneceu.
                            Mas lembre-se, eu sou um chatbot e não tenho consciência própria, então minhas respostas
                            podem
                            não ser perfeitas. Sempre revise as respostas antes de tomar decisões importantes.
                            <span class="message-time">Agora</span>
                        </div>
                        <div id="typing-indicator" class="typing-indicator">
                            <em class="icon ni ni-user-fill me-2"></em> Assistente está digitando
                            <span class="ms-2"></span>
                            <span></span>
                            <span></span>
                        </div>
                        `);
                        atualizarInfoConversa();
                    }
                    carregarConversasSidebar();
                } else {
                    alert('Erro ao deletar conversa: ' + data.message);
                }
            })
            .catch(error => {
                alert('Erro ao deletar conversa');
                console.error('Erro na requisição:', error);
            });
    }
         });

    // Função para editar título da conversa (escopo global)
    function editarTituloConversa() {
        try {
            if (!conversaAtual) {
                console.log('Nenhuma conversa selecionada');
                return;
            }

            const novo_titulo = document.getElementById('novo_titulo');
            if (novo_titulo) {
                novo_titulo.value = conversaAtual.titulo || '';
                $('#modalEditarTitulo').modal('show');
            } else {
                console.error('Elemento novo_titulo não encontrado');
            }
        } catch (error) {
            console.error('Erro ao editar título:', error);
        }
    }

    // Função para salvar novo título (escopo global)
    function salvarNovoTitulo() {
        if (!conversaAtual) return;

        const novoTitulo = document.getElementById('novo_titulo').value.trim();
        if (!novoTitulo) return;

        const formData = new FormData();
        formData.append('conversa_id', conversaAtual.id);
        formData.append('titulo', novoTitulo);

        fetch('/api/conversa/atualizar-titulo', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                conversaAtual.titulo = novoTitulo;
                atualizarInfoConversa();
                $('#modalEditarTitulo').modal('hide');
                carregarConversasSidebar();
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Erro ao atualizar título');
            });
    }

    // Função para copiar texto (mantida do código original)
    function copyToClipboard(element) {
        const text = element.getAttribute('data-text');
        navigator.clipboard.writeText(text).then(function () {
            // Feedback visual
            const originalIcon = element.innerHTML;
            element.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(function () {
                element.innerHTML = originalIcon;
            }, 1000);
        });
    }
</script>

<style>
    .list-group-item.active {
        background-color: #007bff;
        border-color: #007bff;
        color: white;
    }

    .list-group-item:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }

    .list-group-item.active:hover {
        background-color: #0056b3;
    }

    .text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}